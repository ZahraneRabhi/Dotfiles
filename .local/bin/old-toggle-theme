#!/bin/bash

# Directories
WAYBAR_DIR="$HOME/.config/waybar"
HYPR_THEMES_DIR="$HOME/.config/hypr/hyprland-modules"
WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
FOOT_DIR="$HOME/.config/foot"

ACTIVE_HYPR="$HYPR_THEMES_DIR/look.conf"
ACTIVE_FOOT="$FOOT_DIR/foot.ini"  # The file foot actually uses

# Theme bundles (name:wallpaper:waybar:hypr:foot)
THEMES=(
    "nebula-clear:$WALLPAPER_DIR/nebula.png:$WAYBAR_DIR/themes/transparent.css:$HYPR_THEMES_DIR/looks/look-transparent.conf:$FOOT_DIR/nebula.ini"
    "nebula-bar:$WALLPAPER_DIR/nebula.png:$WAYBAR_DIR/themes/nebula.css:$HYPR_THEMES_DIR/looks/look-transparent.conf:$FOOT_DIR/nebula.ini"
    "blue-sky:$WALLPAPER_DIR/blue_3.jpg:$WAYBAR_DIR/themes/transparent.css:$HYPR_THEMES_DIR/looks/look-sky.conf:$FOOT_DIR/sky.ini"


    "mountain:$WALLPAPER_DIR/wallhaven-d6r2qo.jpg:$WAYBAR_DIR/themes/transparent.css:$HYPR_THEMES_DIR/looks/look-mountain.conf:$FOOT_DIR/mountain.ini"
    "space-rings:$WALLPAPER_DIR/wallhaven-exj2mw.jpg:$WAYBAR_DIR/themes/transparent.css:$HYPR_THEMES_DIR/looks/look-sunset.conf:$FOOT_DIR/sunset.ini"
    "mars:$WALLPAPER_DIR/wallhaven-l8eejy.jpg:$WAYBAR_DIR/themes/transparent.css:$HYPR_THEMES_DIR/looks/look-sunset.conf:$FOOT_DIR/mars.ini"

    "silver-surfer:$WALLPAPER_DIR/silver.png:$WAYBAR_DIR/themes/transparent.css:$HYPR_THEMES_DIR/looks/look-cobalts.conf:$FOOT_DIR/cobalts.ini"
    "space-window:$WALLPAPER_DIR/wallhaven-zp85do.png:$WAYBAR_DIR/themes/transparent.css:$HYPR_THEMES_DIR/looks/look-cobalts.conf:$FOOT_DIR/cobalts.ini"
    "cyber-lust:$WALLPAPER_DIR/wallhaven-yq8w5k.jpg:$WAYBAR_DIR/themes/cyber.css:$HYPR_THEMES_DIR/looks/look-cyber.conf:$FOOT_DIR/cyber.ini"

    "green-vinland:$WALLPAPER_DIR/wallhaven-qzwxgq.jpg:$WAYBAR_DIR/themes/green-vinland.css:$HYPR_THEMES_DIR/looks/look-green-vinland.conf:$FOOT_DIR/green-vinland.ini"
)

# Index state file
INDEX_FILE="$WALLPAPER_DIR/.wallpaper_index"
if [ ! -f "$INDEX_FILE" ]; then
    echo 0 > "$INDEX_FILE"
fi
INDEX=$(cat "$INDEX_FILE")

# Decide next index
DIRECTION=${1:-next} # default = next

if [ "$DIRECTION" = "prev" ]; then
    NEXT_INDEX=$(( (INDEX - 1 + ${#THEMES[@]}) % ${#THEMES[@]} ))
elif [ "$DIRECTION" = "random" ]; then
    NEXT_INDEX=$((RANDOM % ${#THEMES[@]}))
else
    NEXT_INDEX=$(( (INDEX + 1) % ${#THEMES[@]} ))
fi
echo $NEXT_INDEX > "$INDEX_FILE"

# Parse theme bundle
IFS=":" read -r NAME WALLPAPER WAYBAR_THEME HYPR_THEME FOOT_THEME <<< "${THEMES[$NEXT_INDEX]}"

# --- Apply theme ---

# Waybar
ln -sf "$WAYBAR_THEME" "$WAYBAR_DIR/style.css"

# Hyprland
ln -sf "$HYPR_THEME" "$ACTIVE_HYPR"

# Foot
ln -sf "$FOOT_THEME" "$ACTIVE_FOOT"
pkill -x foot 2>/dev/null

# Wallpaper (apply to all monitors)
for monitor in $(hyprctl monitors -j | jq -r '.[].name'); do
    hyprctl hyprpaper preload "$WALLPAPER"
    hyprctl hyprpaper wallpaper "$monitor,$WALLPAPER"
done

# Restart Waybar
if pgrep -x waybar >/dev/null; then
    pkill -x waybar
    while pgrep -x waybar >/dev/null; do sleep 0.1; done
fi
nohup waybar >/dev/null 2>&1 &

# Reload Hyprland
hyprctl reload

# Notification
notify-send "Theme switched" "Now using: $NAME"
