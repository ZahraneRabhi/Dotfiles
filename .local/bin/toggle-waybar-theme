#!/bin/bash

# Directories
WAYBAR_DIR="$HOME/.config/waybar"
HYPR_THEMES_DIR="$HOME/.config/hypr/hyprland-modules"
WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
FOOT_DIR="$HOME/.config/foot"

ACTIVE_HYPR="$HYPR_THEMES_DIR/look.conf"
ACTIVE_FOOT="$FOOT_DIR/foot.ini"

# --- Theme bundles ---
# Format: name:wallpaper:waybar:hypr:foot
THEMES=(
    "Nebula Depth:$WALLPAPER_DIR/nebula.png:$WAYBAR_DIR/themes/transparent.css:$HYPR_THEMES_DIR/looks/look-transparent.conf:$FOOT_DIR/nebula.ini"
    "Nebula Depth V.2:$WALLPAPER_DIR/nebula.png:$WAYBAR_DIR/themes/nebula.css:$HYPR_THEMES_DIR/looks/look-transparent.conf:$FOOT_DIR/nebula.ini"
    "Mount Blue:$WALLPAPER_DIR/blue_3.jpg:$WAYBAR_DIR/themes/transparent.css:$HYPR_THEMES_DIR/looks/look-sky.conf:$FOOT_DIR/sky.ini"
    "Mount Pinkerton :$WALLPAPER_DIR/wallhaven-d6r2qo.jpg:$WAYBAR_DIR/themes/transparent.css:$HYPR_THEMES_DIR/looks/look-mountain.conf:$FOOT_DIR/mountain.ini"
    "Celestial Ring:$WALLPAPER_DIR/wallhaven-exj2mw.jpg:$WAYBAR_DIR/themes/transparent.css:$HYPR_THEMES_DIR/looks/look-sunset.conf:$FOOT_DIR/sunset.ini"
    "Mars:$WALLPAPER_DIR/wallhaven-l8eejy.jpg:$WAYBAR_DIR/themes/transparent.css:$HYPR_THEMES_DIR/looks/look-sunset.conf:$FOOT_DIR/mars.ini"
    "Silver Surfer:$WALLPAPER_DIR/silver.png:$WAYBAR_DIR/themes/transparent.css:$HYPR_THEMES_DIR/looks/look-cobalts.conf:$FOOT_DIR/cobalts.ini"
    "Interstellar:$WALLPAPER_DIR/wallhaven-zp85do.png:$WAYBAR_DIR/themes/transparent.css:$HYPR_THEMES_DIR/looks/look-cobalts.conf:$FOOT_DIR/cobalts.ini"
    "R3D:$WALLPAPER_DIR/wallhaven-yq8w5k.jpg:$WAYBAR_DIR/themes/cyber.css:$HYPR_THEMES_DIR/looks/look-cyber.conf:$FOOT_DIR/cyber.ini"
    "Litteral Vinland:$WALLPAPER_DIR/wallhaven-qzwxgq.jpg:$WAYBAR_DIR/themes/green-vinland.css:$HYPR_THEMES_DIR/looks/look-green-vinland.conf:$FOOT_DIR/green-vinland.ini"
    "Renaissance:$WALLPAPER_DIR/wallhaven-x6vldd.jpg:$WAYBAR_DIR/themes/renaissance.css:$HYPR_THEMES_DIR/looks/look-renaissance.conf:$FOOT_DIR/renaissance.ini"
    "The Anatomy :$WALLPAPER_DIR/wallhaven-8xxprk.jpg:$WAYBAR_DIR/themes/anatomy.css:$HYPR_THEMES_DIR/looks/look-anatomy.conf:$FOOT_DIR/anatomy.ini"
)


# --- Wofi menu ---
# Extract just theme names for menu
THEME_NAMES=()
for item in "${THEMES[@]}"; do
    THEME_NAMES+=("$(echo "$item" | cut -d':' -f1)")
done

# Use Wofi to select theme
SELECTED=$(printf "%s\n" "${THEME_NAMES[@]}" | wofi --dmenu --prompt "Select Theme" --width 400 --height 600 --lines ${#THEME_NAMES[@]} --columns 1 --cache-file /dev/null)

# If user cancelled, exit
[ -z "$SELECTED" ] && exit 0

# --- Find the selected theme bundle ---
for entry in "${THEMES[@]}"; do
    IFS=":" read -r NAME WALLPAPER WAYBAR_THEME HYPR_THEME FOOT_THEME <<< "$entry"
    if [[ "$NAME" == "$SELECTED" ]]; then
        # Apply Waybar theme
        ln -sf "$WAYBAR_THEME" "$WAYBAR_DIR/style.css"

        # Apply Hyprland theme
        ln -sf "$HYPR_THEME" "$ACTIVE_HYPR"

        # Apply Foot theme
        ln -sf "$FOOT_THEME" "$ACTIVE_FOOT"
        pkill -x foot 2>/dev/null

        # Apply wallpaper to all monitors
        for monitor in $(hyprctl monitors -j | jq -r '.[].name'); do
            hyprctl hyprpaper preload "$WALLPAPER"
            hyprctl hyprpaper wallpaper "$monitor,$WALLPAPER"
        done

        # Restart Waybar
        if pgrep -x waybar >/dev/null; then
            pkill -x waybar
            while pgrep -x waybar >/dev/null; do sleep 0.1; done
        fi
        nohup waybar >/dev/null 2>&1 &

        # Reload Hyprland
        hyprctl reload

        # Notify
        notify-send "Theme switched" "Now using: $NAME"
        break
    fi
done
